<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Futures Arbitrage Strategy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .price-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin: 1rem 0;
            transition: transform 0.3s ease;
        }
        .price-card:hover {
            transform: translateY(-5px);
        }
        .price-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        .signal-card {
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .contango {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 5px solid #2196f3;
        }
        .backwardation {
            background: linear-gradient(135deg, #fff3e0, #ffcc80);
            border-left: 5px solid #ff9800;
        }
        .neutral {
            background: linear-gradient(135deg, #f3e5f5, #ce93d8);
            border-left: 5px solid #9c27b0;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 2rem 0;
            height: 400px;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .last-updated {
            color: #666;
            font-size: 0.9rem;
            text-align: right;
            margin-top: 1rem;
        }
        .spread-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }
        .spread-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <h1><i class="fas fa-coins"></i> Gold Futures Arbitrage Strategy</h1>
            <p class="mb-0">Real-time analysis of gold spot vs futures prices for arbitrage opportunities</p>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Current Prices Row -->
        <div class="row">
            <div class="col-md-6">
                <div class="price-card">
                    <h5><i class="fas fa-chart-line"></i> Gold Spot Price</h5>
                    <div class="price-value" id="spotPrice">Loading...</div>
                    <small class="text-muted" id="spotName">XAUS.L</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="price-card">
                    <h5><i class="fas fa-calendar-alt"></i> Gold Future Price</h5>
                    <div class="price-value" id="futurePrice">Loading...</div>
                    <small class="text-muted" id="futureName">GCU25.CMX</small>
                </div>
            </div>
        </div>

        <!-- Signal Analysis -->
        <div class="row">
            <div class="col-12">
                <div class="signal-card" id="signalCard">
                    <h5><i class="fas fa-signal"></i> Market Analysis & Trading Signal</h5>
                    <div id="marketCondition" class="h6 mb-3">Analyzing...</div>
                    <div id="tradingSignal" class="mb-2">Loading signal...</div>
                    <div id="signalExplanation" class="text-muted mb-3">Please wait...</div>
                    
                    <div class="spread-info">
                        <div>
                            <strong>Price Spread:</strong> 
                            <span class="spread-value" id="priceSpread">$0.00</span>
                        </div>
                        <div>
                            <strong>Spread %:</strong> 
                            <span class="spread-value" id="spreadPercentage">0.00%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-area"></i> Historical Price Comparison (Last 30 Days)</h5>
                    <canvas id="priceChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <div class="last-updated" id="lastUpdated">
            Last updated: Loading...
        </div>
    </div>

    <script>
        let priceChart;
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            loadCurrentPrices();
            loadHistoricalData();
            
            // Refresh data every 60 seconds
            setInterval(() => {
                loadCurrentPrices();
                loadHistoricalData();
            }, 60000);
        });

        function initializeChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Gold Spot Price',
                        data: [],
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        tension: 0.4,
                        fill: false
                    }, {
                        label: 'Gold Future Price',
                        data: [],
                        borderColor: '#FF6B35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price (USD)'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        async function loadCurrentPrices() {
            try {
                const response = await fetch('/api/current-prices');
                const data = await response.json();
                
                if (data.error) {
                    showError('Error loading current prices: ' + data.error);
                    return;
                }

                // Update price displays
                document.getElementById('spotPrice').textContent = `$${data.spot_price.toFixed(2)}`;
                document.getElementById('futurePrice').textContent = `$${data.future_price.toFixed(2)}`;
                document.getElementById('spotName').textContent = data.spot_name;
                document.getElementById('futureName').textContent = data.future_name;

                // Update signal analysis
                updateSignalDisplay(data);

                // Update timestamp
                const lastUpdated = new Date(data.last_updated).toLocaleString();
                document.getElementById('lastUpdated').textContent = `Last updated: ${lastUpdated}`;

            } catch (error) {
                console.error('Error loading current prices:', error);
                showError('Failed to load current prices. Please refresh the page.');
            }
        }

        function updateSignalDisplay(data) {
            const signalCard = document.getElementById('signalCard');
            const marketCondition = document.getElementById('marketCondition');
            const tradingSignal = document.getElementById('tradingSignal');
            const signalExplanation = document.getElementById('signalExplanation');
            const priceSpread = document.getElementById('priceSpread');
            const spreadPercentage = document.getElementById('spreadPercentage');

            // Update market condition
            marketCondition.innerHTML = `<strong>Market Condition:</strong> ${data.condition.toUpperCase()}`;
            
            // Update trading signal
            tradingSignal.innerHTML = `<strong><i class="fas fa-exchange-alt"></i> Trading Signal:</strong> ${data.signal}`;
            
            // Update explanation
            signalExplanation.textContent = data.explanation;
            
            // Update spread information
            priceSpread.textContent = `$${data.spread.toFixed(2)}`;
            spreadPercentage.textContent = `${data.spread_percentage.toFixed(4)}%`;

            // Update card styling based on condition
            signalCard.className = `signal-card ${data.condition}`;
        }

        async function loadHistoricalData() {
            try {
                const response = await fetch('/api/historical-data');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading historical data:', data.error);
                    return;
                }

                // Update chart with new data
                priceChart.data.labels = data.dates;
                priceChart.data.datasets[0].data = data.spot_prices;
                priceChart.data.datasets[1].data = data.future_prices;
                priceChart.data.datasets[0].label = data.spot_name;
                priceChart.data.datasets[1].label = data.future_name;
                priceChart.update();

            } catch (error) {
                console.error('Error loading historical data:', error);
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.row'));
            
            // Remove error after 10 seconds
            setTimeout(() => {
                errorDiv.remove();
            }, 10000);
        }
    </script>
</body>
</html>